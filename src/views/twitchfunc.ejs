<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../css/cssdir/out.css" rel="stylesheet" />
    <title>Gerenciador de Funções - Twitch</title>
  </head>
  <body class="bg-slate-900 text-white min-h-screen flex items-center justify-center">

    <div class="pages_cont p-8 rounded-lg shadow-md w-full max-w-7xl">
      <div id="mensagemPopUp" class="hidden fixed top-15 right-3 z-50"></div>

      <div class="flex items-center gap-5 px-4 sm:px-0">
        <div class="flex-shrink-0">
          <% if (info.icon && info.icon.indexOf('null') === -1) { %>
            <img src="<%= info.icon %>" alt="Ícone da guilda" class="w-24 h-24 rounded-lg object-cover" />
          <% } else { %>
            <img src="/res/serverIcon/nonserverimg.jpg" alt="Ícone padrão" class="w-24 h-24 rounded-lg object-cover" />
          <% } %>
        </div>
        <div class="flex-1">
          <h3 class="text-base/7 font-semibold text-white">Canais na Twitch</h3>
          <p class="mt-1 max-w-2xl text-sm/6 text-gray-400">Lista completa com todos os canais que estão gerando notificações de lives no seu Servidor.</p>
        </div>
        <div class="flex items-center">
          <button onclick="abrirModal()" class="block rounded-md bg-indigo-500 px-3 py-2 text-center text-sm font-semibold text-white hover:bg-indigo-400">
            Ativar Função
          </button>
        </div>
      </div>

      <div id="modal" class="hidden fixed inset-0 backdrop-blur items-center justify-center">
        <form id="addDataForm" method="post" class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-lg">
          <div class="mb-4 flex items-center">
            <input type="checkbox" id="tch" name="tch" class="mr-2 h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-500 focus:ring-indigo-500" required />
            <label for="tch" class="text-gray-300">Habilitar Twitch</label>
          </div>
          <div class="mb-6">
            <label for="channelId" class="block text-sm font-medium text-gray-300 mb-2">ID do Canal para Notificar as Lives:</label>
            <input type="number" id="channelId" name="channelId" class="p-2 w-full border rounded-md bg-slate-700 border-slate-600 text-white placeholder-gray-400" required />
          </div>
          <input type="hidden" id="guildId" name="guildId" value="<%= info.id %>" />
          <input type="hidden" id="func" name="func" value="acttwitch" />
          <div class="flex justify-end space-x-4">
            <button type="button" onclick="fecharModal()" class="py-2 px-4 bg-slate-600 hover:bg-slate-500 text-white rounded-md">Fechar</button>
            <button type="button" onclick="envdata()" class="py-2 px-4 bg-indigo-500 hover:bg-indigo-400 text-white rounded-md">Adicionar</button>
          </div>
        </form>
      </div>

      <div class="flex max-w-7xl mt-8">
        <table class="w-full table-fixed divide-y divide-white-700">
          <thead>
            <tr>
              <th scope="col" class="w-[40%] py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-0">Twitch</th>
              <th scope="col" class="w-[30%] px-3 py-3.5 text-left text-sm font-semibold text-white">Channel</th>
              <th scope="col" class="w-[30%] px-3 py-3.5 text-left text-sm font-semibold text-white">Notify Guild</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800">
            <% info3.forEach(item => { %>
              <tr>
                <td class="truncate py-4 pl-4 pr-3 text-sm font-medium text-white sm:pl-0"><%= item.twitch %></td>
                <td class="truncate px-3 py-4 text-sm text-gray-300"><%= item.channel %></td>
                <td class="truncate px-3 py-4 text-sm text-gray-300"><%= item.guildID %></td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      function abrirModal() {
        document.getElementById("modal").style.display = "flex";
      }

      function fecharModal() {
        document.getElementById("modal").style.display = "none";
      }

      // --- NOVA FUNÇÃO PARA EXIBIR A MENSAGEM ---
      function exibirMensagemErro(mensagem) {
        const popUp = document.getElementById('mensagemPopUp');
        
        // Cria o visual do pop-up com classes do Tailwind
        popUp.innerHTML = `
          <div class="bg-red-500 text-white font-bold rounded-lg px-4 py-3 shadow-xl" role="alert">
            <p>${mensagem}</p>
          </div>
        `;
        // Mostra o pop-up
        popUp.classList.remove('hidden');
        // Esconde o pop-up automaticamente após 3 segundos
        setTimeout(() => {
          popUp.classList.add('hidden');
        }, 3000);
      }

      // --- SUA FUNÇÃO MODIFICADA ---
      function envdata() {
        var form = document.getElementById('addDataForm');

        // 1. VERIFICAÇÃO: Checa se o formulário é válido
        // O método checkValidity() respeita os atributos "required" dos seus inputs.
        if (!form.checkValidity()) {
          // 2. Se for inválido, chama a função de erro e para a execução.
          exibirMensagemErro('Por favor, preencha todos os campos obrigatórios.');
          return; // Impede que o resto da função rode
        }

        // 3. Se for válido, o código continua normalmente.
        var formData = new FormData(form);
        var dadosFormulario = $("#addDataForm").serializeArray();

        fecharModal();
        parent.funcsReload(dadosFormulario);
      }
    </script>
  </body>
</html>