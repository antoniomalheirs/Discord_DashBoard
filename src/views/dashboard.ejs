<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../css/cssdir/out.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <title>Server Select - Manager Bot</title>
  </head>
  <body class="backgroundMain grid grid-cols-2 gap-4 w-auto h-auto ">
    <div class="w-auto h-auto text-center content-center">
      <h2 class="text-3xl font-bold tracking-tight sm:text-4xl colorTextMain">
        Escolha o servidor desejado para gerenciar
      </h2>
      <p class="mt-6 text-lg leading-8 colorTextMainNOHOVER">
        Para acessar o servidor você deve ter as permissões necessarias para
        manipular os dados do servidor em questão.
      </p>
    </div>
    <div class="w-11/12 h-auto mt-10 text-center">
      <div class="grid grid-cols-2 gap-[18px] ">
        <% user.guilds.forEach(guild => { %>
          <ul class="glowing-list rounded-md grid grid-cols-2">
            <div class="grid grid-rows-2 ">
              <div>
                <li>
                  <h3 class="text-lg font-semibold colorTextMain">
                    <%= guild.name %>
                  </h3>
                </li>
              </div>  
              <div> 
                <li>
                  <p class="text-sm mb-[18px] colorTextMainNOHOVER">
                    <%= guild.id %>
                  </p>
                  <form action="/bot/botinfo" method="post" class="flex flex-auto justify-center space-y-4 mt-[8px]">
                    <input type="hidden" id="guilds" name="guilds" value="<%= guild.id %>"/>
                    <input type="hidden" id="nameofGuild" name="nameofGuild" value="<%= guild.name %>"/>
                    <input type="hidden" id="icon" name="icon" value="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png"/>
                    <button class="selectButton bg-indigo-500 type="submit"  ">
                      Selecionar
                    </button>
                  </form>
                </li>
              </div>
            </div>
            <div class="grid content-center justify-end">
              <li>
                <img class="h-40 w-40 rounded-4xl" src="/res/serverIcon/nonserverimg.jpg" id="AguildIcon<%= guild.id %>"/>
              </li>
            </div>
          </ul>
        <% }); %>
      </div>
    </div>
    <script>
      async function redirecionarParaRota(guildId) {
          try {
              const response = await fetch(`/bot/obter-icone-guilda/${guildId}`);
              const data = await response.json();
              const guildIcon = document.getElementById("AguildIcon" + guildId);
              if (data.iconURL) {
                  guildIcon.src = data.iconURL;
                  guildIcon.style.backgroundColor = "transparent";
              } else {
                  guildIcon.src = "/res/serverIcon/nonserverimg.jpg";
              }
          } catch (error) {
              console.error("Erro ao carregar imagem da guilda:", error);
          }
      }

      // Replace EJS block with plain JS loop using EJS-rendered array
      window.onload = function() {
          const guilds = JSON.parse('<%- JSON.stringify(user.guilds) %>');
          guilds.forEach(guild => {
              redirecionarParaRota(guild.id);
          });
      }
    </script>
    <div class="transition-overlay_out_2 w-full h-full"></div>
  </body>
</html>
